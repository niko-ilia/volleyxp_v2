# VolleyXP Backend API

Backend API –¥–ª—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤–æ–ª–µ–π–±–æ–ª—å–Ω—ã–º–∏ –º–∞—Ç—á–∞–º–∏.

## –¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏

- Node.js >= 18.x
- Express.js
- MongoDB
- JWT Authentication
- bcryptjs –¥–ª—è —Ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è –ø–∞—Ä–æ–ª–µ–π

## –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –∑–∞–ø—É—Å–∫

### –õ–æ–∫–∞–ª—å–Ω–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞

1. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:
```bash
npm install
```

2. –°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª `.env` —Å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏ –æ–∫—Ä—É–∂–µ–Ω–∏—è:
```env
MONGODB_URI=mongodb://localhost:27017/volleyxp
JWT_SECRET=your-secret-key
PORT=5000
```

3. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä:
```bash
npm run dev
```

### –ü—Ä–æ–¥–∞–∫—à–Ω

```bash
npm start
```

## API Endpoints

### –û—Å–Ω–æ–≤–Ω—ã–µ
- `GET /api/ping` - –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏

### –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
- `POST /api/auth/register` - –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `POST /api/auth/login` - –í—Ö–æ–¥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `POST /api/auth/telegram` - –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ Telegram
- `POST /api/auth/forgot-password` - –ó–∞–ø—Ä–æ—Å —Å–±—Ä–æ—Å–∞ –ø–∞—Ä–æ–ª—è
- `POST /api/auth/reset-password` - –°–±—Ä–æ—Å –ø–∞—Ä–æ–ª—è –ø–æ —Ç–æ–∫–µ–Ω—É
- `POST /api/auth/confirm-email` - –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ email

### –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
- `GET /api/users/profile` - –ü–æ–ª—É—á–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `PUT /api/users/profile` - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `GET /api/users/match-history` - –ü–æ–ª—É—á–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ –º–∞—Ç—á–µ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `GET /api/users/email/:email` - –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ email (–∞–¥–º–∏–Ω)
- `GET /api/users/search?q=query` - **–ù–û–í–û–ï**: –£–º–Ω—ã–π –ø–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–æ –∏–º–µ–Ω–∏ –∏–ª–∏ email

### –ú–∞—Ç—á–∏
- `GET /api/matches` - –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –º–∞—Ç—á–µ–π
- `GET /api/matches/:id` - –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –º–∞—Ç—á–∞
- `POST /api/matches` - –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –º–∞—Ç—á–∞
- `POST /api/matches/:id/join` - –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∫ –º–∞—Ç—á—É
- `POST /api/matches/:id/leave` - –í—ã—Ö–æ–¥ –∏–∑ –º–∞—Ç—á–∞
- `PATCH /api/matches/:id` - –û—Ç–º–µ–Ω–∞/—É–¥–∞–ª–µ–Ω–∏–µ –º–∞—Ç—á–∞ (—Å–æ–∑–¥–∞—Ç–µ–ª—å)
- `POST /api/matches/:id/add-player` - **–ù–û–í–û–ï**: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∏–≥—Ä–æ–∫–∞ –≤ –º–∞—Ç—á (–∞–¥–º–∏–Ω/—Å–æ–∑–¥–∞—Ç–µ–ª—å)

### –†–µ–∑—É–ª—å—Ç–∞—Ç—ã
- `GET /api/results` - –ü–æ–ª—É—á–µ–Ω–∏–µ –≤—Å–µ—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
- `GET /api/results/:matchId` - –ü–æ–ª—É—á–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –º–∞—Ç—á–∞
- `POST /api/results` - –°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –º–∞—Ç—á–∞
- `PUT /api/results/:id` - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –º–∞—Ç—á–∞

## –î–µ–ø–ª–æ–π

### Render.com (–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

1. –°–æ–∑–¥–∞–π—Ç–µ –∞–∫–∫–∞—É–Ω—Ç –Ω–∞ [Render.com](https://render.com)
2. –ü–æ–¥–∫–ª—é—á–∏—Ç–µ –≤–∞—à GitHub —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
3. –°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π Web Service
4. –£–∫–∞–∂–∏—Ç–µ:
   - Build Command: `npm install`
   - Start Command: `npm start`
   - Environment Variables:
     - `MONGODB_URI` - URI –≤–∞—à–µ–π MongoDB –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
     - `JWT_SECRET` - —Å–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á –¥–ª—è JWT
     - `NODE_ENV` - production

### Railway

1. –°–æ–∑–¥–∞–π—Ç–µ –∞–∫–∫–∞—É–Ω—Ç –Ω–∞ [Railway.app](https://railway.app)
2. –ü–æ–¥–∫–ª—é—á–∏—Ç–µ –≤–∞—à GitHub —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
3. Railway –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–∑ `railway.json`
4. –î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –ø—Ä–æ–µ–∫—Ç–∞

### Heroku

1. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ Heroku CLI
2. –°–æ–∑–¥–∞–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ:
```bash
heroku create your-app-name
```

3. –î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:
```bash
heroku config:set MONGODB_URI=your-mongodb-uri
heroku config:set JWT_SECRET=your-secret-key
heroku config:set NODE_ENV=production
```

4. –î–µ–ø–ª–æ–π—Ç–µ:
```bash
git push heroku main
```
> ‚ö†Ô∏è –ï—Å–ª–∏ –¥–µ–ø–ª–æ–π—Ç–µ –Ω–∞ Vercel ‚Äî –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –∏ –∏–∑–º–µ–Ω–∏—Ç–µ rewrite-–¥–æ–º–µ–Ω –≤ vercel.json ("destination": "https://api.volleyxp.com/api/$1") –Ω–∞ –≤–∞—à –∞–∫—Ç—É–∞–ª—å–Ω—ã–π backend API.

## –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

–î–ª—è –ø—Ä–æ–¥–∞–∫—à–Ω–∞ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å MongoDB Atlas:

1. –°–æ–∑–¥–∞–π—Ç–µ –∫–ª–∞—Å—Ç–µ—Ä –Ω–∞ [MongoDB Atlas](https://mongodb.com/atlas)
2. –ü–æ–ª—É—á–∏—Ç–µ connection string
3. –î–æ–±–∞–≤—å—Ç–µ –µ–≥–æ –∫–∞–∫ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è `MONGODB_URI`

## –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

### –û—Å–Ω–æ–≤–Ω—ã–µ
- `MONGODB_URI` - URI –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ MongoDB
- `JWT_SECRET` - –°–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á –¥–ª—è JWT —Ç–æ–∫–µ–Ω–æ–≤
- `PORT` - –ü–æ—Ä—Ç —Å–µ—Ä–≤–µ—Ä–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 5000)
- `NODE_ENV` - –û–∫—Ä—É–∂–µ–Ω–∏–µ (development/production)

### Email —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å
- `FRONTEND_URL` - URL —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è —Å—Å—ã–ª–æ–∫ –≤ email
- `MAILGUN_API_KEY` - API-–∫–ª—é—á Mailgun –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ email (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
- `MAILGUN_DOMAIN` - –¥–æ–º–µ–Ω Mailgun, —Å –∫–æ—Ç–æ—Ä–æ–≥–æ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –ø–∏—Å—å–º–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
- `EMAIL_CONFIRM_SECRET` - —Å–µ–∫—Ä–µ—Ç –¥–ª—è –ø–æ–¥–ø–∏—Å–∏ —Ç–æ–∫–µ–Ω–æ–≤ email-–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
- `RESET_PASSWORD_SECRET` - —Å–µ–∫—Ä–µ—Ç –¥–ª—è –ø–æ–¥–ø–∏—Å–∏ —Ç–æ–∫–µ–Ω–æ–≤ —Å–±—Ä–æ—Å–∞ –ø–∞—Ä–æ–ª—è

> **–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ**: –ï—Å–ª–∏ `MAILGUN_API_KEY` –∏ `MAILGUN_DOMAIN` –Ω–µ –∑–∞–¥–∞–Ω—ã, email-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –±—É–¥—É—Ç –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å—Å—è –≤ –∫–æ–Ω—Å–æ–ª—å –±–µ–∑ –æ—Ç–ø—Ä–∞–≤–∫–∏.

## –ù–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏

### üîç –£–º–Ω—ã–π –ø–æ–∏—Å–∫ –∏–≥—Ä–æ–∫–æ–≤
- **–≠–Ω–¥–ø–æ–∏–Ω—Ç**: `GET /api/users/search?q=query`
- **–û–ø–∏—Å–∞–Ω–∏–µ**: –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–æ –∏–º–µ–Ω–∏ –∏–ª–∏ email —Å —É–º–Ω–æ–π —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–æ–π
- **–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏**:
  - –†–µ–≥–∏—Å—Ç—Ä–æ–Ω–µ–∑–∞–≤–∏—Å–∏–º—ã–π –ø–æ–∏—Å–∫
  - –ü–æ–∏—Å–∫ –æ—Ç 2+ —Å–∏–º–≤–æ–ª–æ–≤
  - –£–º–Ω–∞—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞: —Ç–æ—á–Ω—ã–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è ‚Üí –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å ‚Üí —Å–æ–¥–µ—Ä–∂–∏—Ç
  - –õ–∏–º–∏—Ç: 10 —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
  - –ó–∞—â–∏—Ç–∞ –æ—Ç RegExp injection

### ‚ûï –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∏–≥—Ä–æ–∫–æ–≤ –≤ –º–∞—Ç—á
- **–≠–Ω–¥–ø–æ–∏–Ω—Ç**: `POST /api/matches/:id/add-player`
- **–¢–µ–ª–æ –∑–∞–ø—Ä–æ—Å–∞**: `{ "playerEmail": "user@example.com" }`
- **–û–ø–∏—Å–∞–Ω–∏–µ**: –ü–æ–∑–≤–æ–ª—è–µ—Ç —Å–æ–∑–¥–∞—Ç–µ–ª—é –º–∞—Ç—á–∞ –¥–æ–±–∞–≤–ª—è—Ç—å –∏–≥—Ä–æ–∫–æ–≤ –ø–æ email
- **–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è**:
  - –¢–æ–ª—å–∫–æ –¥–ª—è —Å–æ–∑–¥–∞—Ç–µ–ª—è –º–∞—Ç—á–∞
  - –ù–µ–ª—å–∑—è –¥–æ–±–∞–≤–∏—Ç—å —É–∂–µ —É—á–∞—Å—Ç–≤—É—é—â–µ–≥–æ –∏–≥—Ä–æ–∫–∞
  - –ù–µ–ª—å–∑—è –¥–æ–±–∞–≤–∏—Ç—å –≤ –ø–æ–ª–Ω—ã–π –º–∞—Ç—á
  - –ù–µ–ª—å–∑—è –¥–æ–±–∞–≤–∏—Ç—å –≤ –ø—Ä–æ—à–µ–¥—à–∏–π –º–∞—Ç—á

### üóÑÔ∏è –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
- **–ò–Ω–¥–µ–∫—Å—ã**: –î–æ–±–∞–≤–ª–µ–Ω—ã –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è –≤—Å–µ—Ö –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- **–ü—É–ª —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π**: –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω—ã –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ MongoDB
- **–¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–∞—Ü–∏—è**: –ï–¥–∏–Ω—ã–π –º–æ–¥—É–ª—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î (`utils/db.js`)

## –°–ª—É–∂–µ–±–Ω—ã–µ —Å–∫—Ä–∏–ø—Ç—ã

–î–ª—è –≤—Å–µ—Ö —Å–ª—É–∂–µ–±–Ω—ã—Ö —Å–∫—Ä–∏–ø—Ç–æ–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä, check-matches.js, fillMissingHistory.js) –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –µ–¥–∏–Ω—ã–π –º–æ–¥—É–ª—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ MongoDB: `backend/utils/db.js`. –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –≤—Å–µ–≥–¥–∞ –±–µ—Ä—ë—Ç—Å—è –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –æ–∫—Ä—É–∂–µ–Ω–∏—è `MONGODB_URI`.

### –î–æ—Å—Ç—É–ø–Ω—ã–µ —Å–∫—Ä–∏–ø—Ç—ã
- `addPlayerToMatch.js` - **–ù–û–í–û–ï**: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∏–≥—Ä–æ–∫–∞ –≤ –º–∞—Ç—á —á–µ—Ä–µ–∑ API
- `checkUserPassword.js` - –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞—Ä–æ–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `markFinishedMatches.js` - –û—Ç–º–µ—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö –º–∞—Ç—á–µ–π
- `resetAllUserRatings.js` - –°–±—Ä–æ—Å —Ä–µ–π—Ç–∏–Ω–≥–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- –∏ –¥—Ä—É–≥–∏–µ...

–ü—Ä–∏–º–µ—Ä .env:
```env
MONGODB_URI=mongodb://localhost:27017/volleyxp
``` 